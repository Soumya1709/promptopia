//nextAuth.routes

import NextAuth from "next-auth";
import GoogleProvider from "next-auth/providers/google";
import User from "@models/user";

import { connectToDB } from "@utils/database";


const handler = NextAuth({
    providers: [
        GoogleProvider({
            clientId: process.env.GOOGLE_ID,
            clientSecret: process.env.GOOGLE_CLIENT_SECRET,
        }),
    ],
    // optional logger to avoid network requests to /_log; logs will be printed
    // to the server console instead. This prevents the missing-module error if
    // the _log route isnâ€™t present or fails.
    logger: {
      error(code, ...err) {
        console.error(code, ...err);
      },
      warn(code) {
        console.warn(code);
      },
      debug(code) {
        console.debug(code);
      },
    },
    callbacks:{
        async session({ session }) {
        const sessionUser = await User.findOne({ email: session.user.email });
        session.user.id = sessionUser._id.toString();
        return session;
        
    },
    async signIn({ profile }) {
        try {
            await connectToDB();
            // check if a user already exists
            const userExists = await User.findOne({ email: profile.email });

            // if not, create a new user
            if (!userExists) {
                await User.create({
                    email: profile.email,
                    username: profile.name.replace(" ", "").toLowerCase(),
                    image: profile.picture,
                });
            }
            return true;
        }catch (error) {
            console.log(error);
            return false;
        }
    }

    }

    
});

export { handler as GET, handler as POST };

export const runtime = "nodejs";



"use client";

import Link from "next/link";
import Image from "next/image";
import { useState, useEffect } from "react";
import { signIn, signOut, useSession, getProviders} from 'next-auth/react';

const Nav = () => {
    const { data: session } = useSession();
    const isUserLoggedIn = session?.user;

    const [providers, setProviders] = useState(null);
    const [toggleDropdown, setToggleDropdown] = useState(false);

    useEffect(() => {
        const setUpProviders = async () => {
            const response = await getProviders();
            setProviders(response);
        };
        setUpProviders();
    }, []);

  return (
    <nav className="flex-between w-full mb-16 pt-3">
        <Link href="/" className="flex gap-2 flex-center">
            <Image 
                src="/assets/images/logo.svg"
                alt="Promptopia Logo"
                width={30}
                height={30}
                className="object-contain"
            />
            <p  className="logo_text">
                Promptopia
            </p>
        </Link> 

        {/* Desktop Navigation */}
        <div className="sm:flex hidden">
            {isUserLoggedIn ? (
                <div className="flex gap-3 md:gap-5">
                    <Link href="/create-prompt" className="black_btn">
                        Create Post
                    </Link>
                    <button type="button" className="outline_btn" onClick={signOut}>
                        Sign Out
                    </button>
                    <Link href="/profile">
                        <Image 
                            src={session?.user.image}
                            width={37}
                            height={37}
                            className="rounded-full"
                            alt="profile"
                            />
                    </Link>

                </div>
            ) : (
                <>
                    {providers && Object.values(providers).map((provider) => (
                        <button 
                            type="button"
                            key={provider.name}
                            onClick={() => signIn(provider.id)}
                            className="black_btn"
                        >
                            Sign In {provider.name}
                        </button>
                    ))}
                </>
            )}

        </div>

        {/* Mobile Navigation */}
        <div className="sm:hidden flex relative">
            {isUserLoggedIn ? (
                <div className="flex">
                    <Image 
                        src={session?.user.image}
                        width={37}
                        height={37}
                        className="rounded-full"
                        alt="profile"
                        onClick={ () => setToggleDropdown(!toggleDropdown) }
                    />

                    {toggleDropdown && (
                        <div className="dropdown">
                            <Link href="/profile" className="dropdown_link"
                                onClick={() => setToggleDropdown(false)}
                             >
                                My Profile
                            </Link>
                            <Link href="/create-prompt" className="dropdown_link"
                                onClick={() => setToggleDropdown(false)}
                             >
                                Create Prompt
                            </Link>
                            <button type="button" onClick={() => { setToggleDropdown(false);
                                signOut(); }} 
                                className="mt-5 w-full black_btn">
                                Sign Out
                            </button>
                        </div>
                    )}
                </div>
            ) : (
                <>
                    {providers && Object.values(providers).map((provider) => (
                        <button 
                            type="button"
                            key={provider.name}
                            onClick={() => signIn(provider.id)}
                            className="black_btn"
                        >
                            Sign In {provider.name}
                        </button>
                    ))}
                </>
            )}
        </div>


      
    </nav>
  )
}

export default Nav
